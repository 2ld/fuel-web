#!/bin/sh

masternode_ip=`sed -rn 's/^.*url=http:\/\/(([0-9]{1,3}\.){3}[0-9]{1,3}).*$/\1/ p' /proc/cmdline`
id=`sed -rn 's/^.*BOOTIF=([0-9a-fA-F-]+).*$/\1/ p' /proc/cmdline|tr -d '\n-'|tail -c12`
echo -n "$id" > /etc/bootif

#
# Sync clock with master node
#
sed -i "/^server\b/ d" /etc/ntp.conf
echo "server $masternode_ip" >> /etc/ntp.conf
/etc/init.d/ntpdate start
/etc/init.d/ntpd start

#
# Update mcollective config
#
sed -i "s/^plugin.stomp.host\b.*$/plugin.stomp.host = $masternode_ip/" /etc/mcollective/server.cfg
sed -i "s/^plugin.stomp.password\b.*$/plugin.stomp.password = marionette/" /etc/mcollective/server.cfg
#echo "identity = $id" >> /etc/mcollective/server.cfg
echo "direct_addressing = 1" >> /etc/mcollective/server.cfg

service mcollective restart
