#!/bin/bash

NAME=nailgun-jobserver

start() {
    echo "Starting nailgun-jobserver..."
    if start-stop-daemon --start --pidfile <%= @params[:pid_file] %> --chuid <%= @params[:user] %> --exec <%= @params[:command] %> \
     -- <%= @params[:command_args] %> start <%= @params[:workers] || 1 %> <%= @celery_options %>; then
	echo "$NAME"
    else
	echo "$NAME failed"
    fi
}

stop() {
    echo "Stopping nailgun-jobserver..."
    if start-stop-daemon --stop --pidfile <%= @params[:pid_file] %> --chuid <%= @params[:user] %> --exec <%= @params[:command] %> --signal QUIT; then
	echo "$NAME"
    else
	echo "$NAME failed"
    fi
}

status() {
    celery_pid=`pgrep -u <%= @params[:user] %> -f <%= @params[:command] %>`
    if [[ -z $celery_pid ]] ; then
        echo "nailgun-jobserver: not running."
    else
        echo "nailgun-jobserver: running."
    fi
}


case "$1" in
  start)
    start
    ;;

  stop)
    stop
    ;;

  restart|reload|force-reload)
    stop
    start
    ;;

  status)
    status
    ;;

  *)
    echo "Usage: /etc/init.d/nailgun-jobserver {start|stop|reload|force-reload|restart|status}"
    exit 1

esac

exit 0